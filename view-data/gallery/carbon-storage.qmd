---
title: "**Carbon Storage **"
description: "*Explore the trees that help keep carbon on the ground.*"
image: "../../images/figure-previews/carbon-storage.png"
---

<br>

Intro text

<br>

```{r, results = 'hide'}
#| error: false
#| echo: false
#| message: false
#| warning: false

#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
## Set-Up ----------------------------------------------------------------------
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# All packages needed
my_packages <- c(
  'tidyverse',
  'openxlsx',
  'plotly',
  'leaflet',
  'leaflet.extras',
  'sf'
)

# Install any packages not already installed
new_packages <- my_packages[!(my_packages %in% installed.packages()[,"Package"])]
if(length(new_packages)){
  install.packages(new_packages)
}

# Library all packages
invisible(lapply(my_packages, library, character.only = TRUE))

# Reduce scientific notation
options(scipen = 9)

# Remove unnecessary objects
rm(new_packages, my_packages)

#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
```

```{r}
#| error: false
#| echo: false
#| message: false
#| warning: false

df <- read.xlsx('../../data/coe-tree-archive-all-years.xlsx')

df <- df %>% filter(!is.na(`Carbon.Storage.(lb)`))

df_list <- split(df, df$Species.Group)

#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
## Distribution of Carbon Storage ----------------------------------------------
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

fig1 <- plot_ly() %>% 
  add_trace(type = "histogram", x = df_list[[8]]$`Carbon.Storage.(lb)`, 
            name = unique(df_list[[8]]$Species.Group), 
            marker = list(color = "rgb(137, 176, 76)"), 
            nbinsx = 20, xbins = list(start = 0)) %>%
  add_trace(type = "histogram", x = df_list[[7]]$`Carbon.Storage.(lb)`, 
            name = unique(df_list[[7]]$Species.Group), 
            marker = list(color = "rgb(194, 208, 94)")) %>%
  add_trace(type = "histogram", x = df_list[[6]]$`Carbon.Storage.(lb)`, 
            name = unique(df_list[[6]]$Species.Group), 
            marker = list(color = "rgb(251, 240, 112)")) %>%
  add_trace(type = "histogram", x = df_list[[5]]$`Carbon.Storage.(lb)`, 
            name = unique(df_list[[5]]$Species.Group), 
            marker = list(color = "rgb(212, 199, 145)")) %>%
  add_trace(type = "histogram", x = df_list[[4]]$`Carbon.Storage.(lb)`, 
            name = unique(df_list[[4]]$Species.Group), 
            marker = list(color = "rgb(179, 107, 107)")) %>%
  add_trace(type = "histogram", x = df_list[[3]]$`Carbon.Storage.(lb)`, 
            name = unique(df_list[[3]]$Species.Group), 
            marker = list(color = "rgb(166, 159, 181)")) %>%
  add_trace(type = "histogram", x = df_list[[2]]$`Carbon.Storage.(lb)`, 
            name = unique(df_list[[2]]$Species.Group), 
            marker = list(color = "rgb(95, 154, 145)")) %>%
  add_trace(type = "histogram", x = df_list[[1]]$`Carbon.Storage.(lb)`, 
            name = unique(df_list[[1]]$Species.Group), 
            marker = list(color = "rgb(58, 65, 60)")) %>%
  layout(barmode="stack", bargap=0.05, 
         title = "Distribution of Carbon Storage",
         xaxis = list(title = "Total Carbon Storage (lbs)", 
                      zeroline = FALSE),
         yaxis = list(title = "Number of Trees", zeroline = FALSE))


#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
## Concentration of Carbon Storage ---------------------------------------------
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


total_storage = sum(df$`Carbon.Storage.(lb)`)

temp <- df %>% 
  rowwise() %>% 
  mutate(
    ptile = ecdf(df$`Carbon.Storage.(lb)`)(`Carbon.Storage.(lb)`),
    top1 = ifelse(ptile > 0.99, `Carbon.Storage.(lb)`, 0)/total_storage,
    top5 = ifelse(ptile > 0.95, `Carbon.Storage.(lb)`, 0)/total_storage,
    top10 = ifelse(ptile > 0.9, `Carbon.Storage.(lb)`, 0)/total_storage,
    top25 = ifelse(ptile > 0.75, `Carbon.Storage.(lb)`, 0)/total_storage
  )

temp <- data.frame(
    storage = c(sum(temp$top1), sum(temp$top5), sum(temp$top10), sum(temp$top25)) * 100,
    order = as.character(1:4),
    ptile = c("Top 1% (3 Trees)", "Top 5% (15 Trees)", "Top 10% (30 Trees)", "Top 25% (75 Trees)")
  ) %>% 
  mutate(
    storage = round(storage, 2)
  )

fig2 <- plot_ly(temp, x = ~order, y = ~storage, type = 'bar',
    hovertemplate = ~paste(ptile,"<br>", storage, "%", sep=""),
    name = "",
    marker = list(color = rep("rgb(95, 154, 145)"))) %>% 
  layout(
    xaxis = list(
      title = "",
      tickvals=list("1", "2", "3", "4"),
      ticktext=list(
        "Top 1%\n(3 Trees)", 
        "Top 5%\n(15 Trees)", 
        "Top 10%\n(30 Trees)", 
        "Top 25%\n(75 Trees)"
      )
    ),
    yaxis = list(
      ticksuffix = "%",
      range = list(0, 100),
      title = "Percent of All Carbon Storage on Campus"
    )
  )


#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
## Estimating Carbon Storage ---------------------------------------------------
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

my_pal <- c("#89b04c", "#c2d05e", '#fbf070', '#d4c791', '#b36b6b', '#a69fb5', 
            '#5f9a91', '#3a413c')

fig3 <- plot_ly(
  data = df, x = ~`DBH.(in)`, y = ~`Carbon.Storage.(lb)`, 
  color = ~`Species.Group`, colors = my_pal, 
  type = "scatter",
  mode = "markers",
  text = ~paste(
    "Tree ID: ", `Tree.ID`, 
    '<br>DBH (in): ', `DBH.(in)`, 
    "<br>Carbon Storage (lb):", `Carbon.Storage.(lb)`),
  hoverinfo = 'text',
  legendgroup = ~`Species.Group`
  ) %>% 
  layout(yaxis = list(title = "Carbon Storage (lb)"), 
         xaxis = list(title = "DBH (in)"),
         title = "Trunk Diameter and Carbon Storage")

fig4 <- plot_ly(
  data = df, x = ~`DBH.(in)`^2, y = ~`Carbon.Storage.(lb)`, 
  color = ~`Species.Group`, colors = my_pal, 
  type = "scatter",
  mode = "markers",
  text = ~paste(
    "Tree ID: ", `Tree.ID`, 
    '<br>DBH (in): ', `DBH.(in)`, 
    "<br>Carbon Storage (lb):", `Carbon.Storage.(lb)`),
  hoverinfo = 'text',
  legendgroup = ~`Species.Group`,
  showlegend = F
  ) %>% 
  layout(yaxis = list(title = "Carbon Storage (lb)"), 
         xaxis = list(title = "Squared DBH (in)"),
         title = "Trunk Diameter and Carbon Storage")

fig5 <- subplot(fig3, fig4, shareY = T, shareX =F, titleX = T) %>% 
  layout(title = 'Estimated Carbon Storage Using Diameter at Breast Height (DBH)')

```

```{r}
#| echo: false
fig1
```

<br>

```{r}
#| echo: false
fig2
```

<br>

```{r}
#| echo: false
fig5
```
